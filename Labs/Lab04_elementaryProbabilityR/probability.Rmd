---
output:
  html_document: default
  pdf_document: default
---


# Lab 3: Probability in R


You will do all your work for this lab in the `console`; so you won't need to touch the `.Rmd` file for this lab.

We'll use the built-in `Titanic` dataset for several questions in this lab

```{r,echo = FALSE}
library(knitr)
```


Load in the `tidyverse` library. Also, run `install.packages("janitor")` and then `library(janitor)`. In your console, type `Titanic`. The `Titanic` dataset displays. To view the dataset, run `view(Titanic)` in the console. You can also learn more about this dataset by running `?Titanic` in the console


First, lets get some practice making contingency tables using `dplyr`. To do so, we'll need to make sure `Titanic` is a `data.frame` object. Run `class(Titanic)` in the console; notice it is a `table` object. We'll need to convert it to a dataframe and then do some preprocessing on it to be able to use it in conjunction with the contingency table functions available in `R`.

Run the following lines in the `console` to update `Titanic`
```{r,eval = FALSE}
Titanic = data.frame(Titanic)
OurTitanic = as.data.frame(lapply(Titanic,rep,Titanic$Freq))

```

Now run the following line in the console:
```{r,eval=FALSE}
OurTitanic %>%
  tabyl(Age,Survived) %>%
  adorn_totals(c("row","col")) %>%
  adorn_percentages("all") %>%
  adorn_ns() %>%
  View()

```
The syntax `x %>% f(.,OTHER_ARGS)` feeds `x` into function `f` in the position where the `.` is located (the first argument). The `%>%` is called the `pipe` in R. So `tabyl` takes as its first argument `Titanic`. In this setting, `taybl` creates a contingency table based on the two variables `Age` and `Survived`. The `adorn_totals` function gives row and column totals respectively. The `adorn_percentages` function will put the marginal percentages next to each count. The `adorn_ns` function ensures that both the counts and percentages display.

The `%>%` is from the `magrittr` library which loads autmoatically when you run `library(tidyverse)`. The `tabyl` function is from the `janitor` package.

If you are ever need help using the `tabyl` function, see [here](https://cran.r-project.org/web/packages/janitor/vignettes/tabyls.html). See [here](https://r4ds.had.co.nz/pipes.html) for more information on the `pipe` operator.

## Question 1: Learning Outcome -- Using `tabyl` to Construct a Contingency Table

Write code to produce a 3 x 2 table of `Class` against `Survived`. Run it. Store the newly created data frame as a variable in your working environment. Now answer question 1 on Canvas.

Tip for Later: Save the code you used to make this plot; perhaps by storing it in an r script file. You may use it later.


## Question 2: Learning Outcome -- Assessing whether events are independent

Let `A` be the event `Being a Member of 1st Class on Titanic`. Let `B` be the event `Surviving the Titanic`. Are the events `A` and `B` independent?

Hint: Use the table you constructed in question 1

## Question 3: Learning Outcome -- Assessing whether events are mutually exclusive

Let `A` be the event `First class child or second class child`. Let `B` be the event `DIED on the Titanic`. Are the events `A` and `B` mutually exclusive?

Hint: Run the below lines to create a table that `filters` by First or Second class child, and displays the total frequency of Survived, and Died.
```{r,eval = FALSE}
#Assuming you have set Titanic = data.frame(Titanic) in your environment
OurTitanic %>%
  filter((Class == "1st" | Class == "2nd") & Age == "Child") %>%
  group_by(Survived) %>%
  summarise(n = sum(Freq)) %>%
  View()

```

## Question 4: Learning Outcome -- Mututal Exclusivity vs Independence

Based on your answer to question 3, are the events `First class child or second class child` and `DIED on the Titanic` independent events?


## Question 5: Learning Outcome -- Using the Addition Rule

Let `A` be the event `Surviving the Titanic` and `B` be the event `Being a member of 3rd class`. Find $P(A \cup B)$.

Hint: The table you created in question 1 may be helpful

## READ

Suppose that in the population that was the 2021 class of CS 3130 students, the event of `X = Getting an A on the First Exam` and `Y = Liking Cilantro` are under study. We collected the corresponding 2x2 table with these two variables for the entire class of 200 students.


## Question 6: Learning Outcome -- Determining Independence from a Population 2x2 Table
Load the `CS3130Cilantro.csv` dataset. Construct a 2x2 table from it based off of the `Got.A` and `Likes.Cilantro` variables. Answer the following question:

Are `Getting an A on the First exam` and `Liking Cilantro` independent in the population of 2021 CS 3130 students?

## READ

Now suppose Albert had no idea whether `Getting an A on the First exam` and `Liking Cilantro` were independent in the population of 2021 CS 3130 students. He wanted to determine this. 

So he collected information from a simple random sample of 12 students and arranged the data into a table like the following:


```{r,echo=FALSE}
sample = data.frame('Got A' = c(4,3,7), 'Did Not Get A' = c(4,1,5),'Total' = c(8,4,12))
row.names(sample) = c('Likes Cilantro','Does Not Like Cilantro','Total')
```

```{r,echo=FALSE}
kable(sample)
```

The above table wasn't Albert's table, but Albert's table had the same margins as the above table. For now we'll just focus on the above table.


Let's assume now that we knew apriori that any sample from the population would have $8$ people that `Liked Cilantro` and $7$ people that `Got an A`. Given this sampling constraint, we'll compute the probability of the above table, and revisit Albert's situation later.

This probability will be computed over the next several questions. But to give you a brief summary of the big picture before we get started:

We can use counting logic similar to that which we used in combinations/permutations and "overcounting" to count up all of the different ways to get this table, and then divided by the factor by which we overcount.

- How many ways can we arrange the 8 folks who Like Cilantro, *taking order into account*?
- How many ways can we arrange the 4 who don't?
- And the 7 who got As?
- And the 5 who did not?

Note that each of these arrangements is a "different choice" in some sense.  So we can use the multiplication rule to combine them.

Now lets begin

## Question 7: Counting Practice 1

Taking order into consideration ordering

How many ways can we arrange the 8 folks who like cilantro?

## READ

While question 7 was only about the folks who like cilantro, also answer this question about the other groups (how many ways can we arrange the 4 who don't like cilantro? how many ways can we arrange the 7 who got As, how many ways can we arrange the 5 who didn't get As). In each case, take order into account.


## Question 8: Counting Practice 2

Imagining for a moment that the 8 cilantro haters, 4 cilantro likers, 7 A students and 5 not A students $\textbf{are all different people}$, how many ways is there to arrange them? 

Hint: Use the multiplication rule

## READ
Using the multiplication rule in question 8 leads to "overcounting" certain arrangements that could result in the contingency table displayed above. Specifically, when we arranged our cilantro-likers, we counted the various arrangments of the 4 who got "A"s, but when we arranged the folks who got "A"s, we AGAIN counted the arrangements of those same 4.  So, we have overcounted by a factor of "the number of ways to arrange 4 people".   

## Question 9: Counting Practice 3
Calculate "the number of ways to arrange" the people in each cell of the contingency table above

Hint: There are 4 cells in the contingency table. We just discussed that in the upper left cell (where there were 4 people), there are $4!$ ways to arrange. Carry out this reasoning in the other three cells; then use the multiplication rule again.

## READ
Dividing the correct answer to question $8$ by the correct answer to question $9$ tells you the number of ways to get a contingency table with 4 "A" students who liked cilantro, 3 "A" students who didn't, 4 non-"A" students who liked cilantro, and 1 non-"A" student who didn't when we already know there are 8 folks who like cilantro, 4 who don't, 7 who got As, and 5 who didn't.

## Question 10: Counting Practice 4

There are 12 students in total that were collected for the displayed contingency table. How many ways can we order the 12 students?

## READ

Under the assumption that `Liking Cilantro` and `Getting an A` are independent events in the population, dividing your answer in question 9 by the answer to question 10 gives the probability that there are 4 "A" students who liked cilantro, 3 "A" students who didn't, 4 non-"A" students who liked cilantro, and 1 non-"A" student who didn't given the specified margins. i.e it is the probability of the table that we keep referring to (which is displayed again below)

```{r,echo=FALSE}
sample = data.frame('Got A' = c(4,3,7), 'Did Not Get A' = c(4,1,5),'Total' = c(8,4,12))
row.names(sample) = c('Likes Cilantro','Does Not Like Cilantro','Total')
```

```{r,echo=FALSE}
kable(sample)
```

## READ

Suppose still that there are $8$ people that `Liked Cilantro` and $7$ people that `Got an A`. There are actually only a couple of possible tables in these circumstances. This is because if we know these margins and specify the upper left cell (or any cell), then the table is determined. And based on the margins, the upper left cell can definitly only take on the values $0,1,2,3,4,5,6,7$ (and actually less as we'll see). You already computed the probability when the upper left cell is $4$.

Denoting $P(Table = i | margins, independence)$ as the conditional probability the upper left cell is $i$ given these margins and given that `Getting A` and `Liking Cilantro` are independent of one another, we can compute for $i=0,1,2,3,4,5,6,7$ $P(Table = i| margins)$. The probabilities are as follows:

```{r,echo=FALSE}
vec = 0:7
computeProb <- function(i) {
  return(choose(8,i)*choose(4,7-i))
}
probs = sapply(vec,computeProb)
probs = probs/sum(probs)
frame = data.frame(i = 0:7,prob = probs)
kable(frame)
```
These probabilities were computed just like you did for the $i =4$ case. We can call this the distribution of the tables *under the hypothesis of assuming independence between Getting an A and Liking Cilantro given 8 people liked Cilantro and 7 people got an A*.

Now recall Albert from a while back. Albert doesn't know whether there is independence of the two events of concern in the population.

Albert wants to conduct a *hypothesis test* to decide whether there is independence between `Getting an A` and `Liking Cilantro`in the population. His test will work in the following manner: Albert believes that very high values of the upper left cell in sample tables is stronger evidence for a lack of independence in the population. He also only wants to reject the null hypothesis of independence (when independence is the case in the population) no more than $5\%$ of the time.

So he will reject when the value of the upper left cell in the sample table he collects is greater than or equal to $Z$, where $Z$ is selected so that he rejects less than or equal to $5\%$ of the time.

## Question 11: Learning Outcome -- Deciding on a Critical Value for the Test

To ensure Albert rejects the test no more than $5\%$ of the time when independence in the population is the truth and the margins are as they have been throughout this problem (i.e 8 Cilantro Likers and 7 A students), what should $Z$ be?

Hint: The distribution under the null is given by the table above. We need to answer the question what should $Z$ be so that $P(table \geq Z | margins,independence) \leq .05$. So $Z$ will be one of $0,1,2,3,4,5,6,7$. You need to pick the correct integer.

## READ

Finally Albert collects a sample given these margins; his table is given below:

```{r,echo=FALSE}
sample = data.frame('Got A' = c(7,0,7), 'Did Not Get A' = c(1,4,5),'Total' = c(8,4,12))
row.names(sample) = c('Likes Cilantro','Does Not Like Cilantro','Total')
kable(sample)
```

## Question 12: Learning Outcome - The Probability of Albert's Table

Does Albert reject the hypothesis that in the population, `Getting an A` and `Liking Cilantro` are independent?

